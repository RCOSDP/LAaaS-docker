version: '3'
services:
  learninglocker:
    build: learninglocker
    container_name: learninglocker
    depends_on:
      - learninglocker_mongo
      - learninglocker_redis
    ports:
      - "3000:3000"
      - "8080:8080"
      - "8081:8081"
    working_dir: /usr/local/src/learninglocker
    command: bash -c "source ~/.bashrc && yarn migrate && pm2 start pm2/all.json && cd ../xapi-service && pm2 start pm2/xapi.json && pm2 logs"
  learninglocker_mongo:
    image: mongo:4.0.8
    container_name: learninglocker_mongo
    restart: always
    volumes:
      - learninglocker_mongo:/data/db
  learninglocker_redis:
    image: redis:5.0.4
    container_name: learninglocker_redis
    restart: always
    volumes:
      - learninglocker_redis:/data
    command: redis-server --appendonly yes
  xapi_stmt_gen:
    build: xapi_stmt_gen
    container_name: xapi_stmt_gen
    volumes:
      - ./xapi_stmt_gen/log:/usr/local/src/xapi_stmt_gen/log
    tty: true
    environment:
      - TZ=Asia/Tokyo
      - INTERVAL=-1
  openlrw_mongo:
    image: mongo:4.0.27
    restart: always
    env_file:
      - open_lrw/.env
    container_name: openlrw_mongo
    volumes:
      - ./open_lrw/init-mongo.sh:/docker-entrypoint-initdb.d/init-mongo.sh
      - openlrw_mongo:/data/db
    ports:
      - "27017:27017"
  openlrw:
    build:
      context: open_lrw
      dockerfile: Dockerfile
    container_name: openlrw_web
    depends_on:
      - openlrw_mongo
    ports:
      - "9966:9966"
    env_file:
      - open_lrw/.env
    command: bash -c "/app/docker-start.sh"
  caliper_stmt_gen:
    container_name: caliper_stmt_gen
    build:
      context: caliper
      dockerfile: Dockerfile
    env_file:
      - caliper/.env
    depends_on:
      - caliper_log_db
      - openlrw
      - openlrw_mongo
  learning_analytics_db:
    image: postgres:11
    container_name: learning_analytics_db
    environment:
      - POSTGRES_USER=learning_analytics
      - POSTGRES_PASSWORD=learning_analytics
      - POSTGRES_DB=learning_analytics
    volumes:
      - ./learning_analytics_db/init:/docker-entrypoint-initdb.d
      - learning_analytics_db:/var/lib/postgresql/data
  caliper_log_db:
    image: postgres:11
    container_name: caliper_log_db
    environment:
      - POSTGRES_USER=caliper_cli
      - POSTGRES_PASSWORD=caliper
      - POSTGRES_DB=caliper_log
    ports:
      - "15432:5432"
    volumes:
      - ./caliper_log/init:/docker-entrypoint-initdb.d
      - caliper_log_db:/var/lib/postgresql/data
  superset:
    build: superset
    container_name: superset
    ports:
      - "8088:8088"
    depends_on:
      - superset-db
    environment:
      - SECRET_KEY=JmAH_gnn9y5T8Wgjt4IBlzjmYMHEGOQONLuJyfmMMOg
    #  - ADMIN_USERNAME=admin
    #  - ADMIN_FIRSTNAME=admin
    #  - ADMIN_LASTNAME=user
    #  - ADMIN_EMAIL=admin@fab.org
    #  - ADMIN_PASSWORD=admin
  superset-db:
    build: superset-db
    container_name: superset-db
    environment:
      - POSTGRES_USER=superset
      - POSTGRES_PASSWORD=superset
      - POSTGRES_DB=superset
      - LRS_HOST=learninglocker_mongo
      - LRS_PORT=27017
      - LRS_DB=learninglocker
      - LRS_DB_USER=
      - LRS_DB_PASSWORD=
      - LRS_COLLECTION=statements
      - LRW_HOST=openlrw_mongo
      - LRW_PORT=27017
      - LRW_DB=caliper
      - LRW_DB_USER=caliper
      - LRW_DB_PASSWORD=caliper
      - LRW_COLLECTION=mongoEvent
    volumes:
      - ./superset-db/init:/docker-entrypoint-initdb.d
      - superset-db:/var/lib/postgresql/data
  jupyterhub:
    build: jupyterhub
    container_name: jupyterhub
    #environment:
    #  - LOCAL_UID=9001
    #  - LOCAL_GID=9001
    ports:
      - "8001:8000"
    volumes:
      - ./jupyterhub/notebooks:/home/jupyter
networks:
  default:
    external:
      name: moodle-docker_default
volumes:
  learninglocker_mongo:
  learninglocker_redis:
  openlrw_mongo:
  learning_analytics_db:
  caliper_log_db:
  superset-db:
