:encoding: utf-8
:lang: ja
:source-highlighter: rouge
:doctype: book
:version-label:
:chapter-label:
:toc:
:toc-title: 目次
:figure-caption: 図
:table-caption: 表
:example-caption: 例
:appendix-caption: 付録
:toclevels: 2
:pagenums:
:sectnums:
:imagesdir: images
:icons: font
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

= Moodleの学習ログ分析

Moodleの学習ログ分析基盤を構築する。

----
docker compose up -d
----

.システム構成
|===
   |項目                  |名称                          |コンテナ名
.2+|学習管理システム      |Moodle(Web)                   |moodle
                          |Moodle(DB)                    |moodle-db
.5+|学習活動のデータストア|Learning Locker(Web)          |learninglocker
                       .2+|Learning Locker(DB)           |learninglocker-mongo
                                                         |learninglocker-redis
                          |OpenLRW(Web)                  |openlrw
                          |OpenLRW(DB)                   |openlrw-mongo
.4+|ステートメント変換    |xAPIステートメント変換        |moodle-xapi
                          |Caliperステートメント変換     |moodle-caliper
                          |Caliperステートメント変換(DB) |caliper-log-db
                          |Learning Analytics DB         |learning-analytics-db
.3+|分析システム          |Superset(Web)                 |superset
                          |Superset(DB)                  |superset-db
                          |JupyterHub(Web/DB)            |jupyterhub
|===

[source, mermaid]
----
graph TB
  ST([Students]) -- Learning Activity                   --> M[Moodle]
  M              -. Learning Log                        .-> X[[xAPI]]    -- xAPI Statements    --> L[(Learning Locker)]
  M              -. Learning Log                        .-> C[[Caliper]] -- Caliper Statements --> O[(OpenLRW)]
  L              -- xAPI Statements                     --> S[Superset]
  L              -- xAPI Statements                     --> J[JupyterHub]
  O              -- Caliper Statements                  --> S
  O              -- Caliper Statements                  --> J
  S              -- Visualization                       --> T([Teachers])
  J              -- Analysis                            --> T
  J              -. Analysis Result                     .-> S
  T              -- Refining Instruction and Coursework --> M
  T              -- Advancing Student Success           --> ST
----

== Moodle
Moodle( http://localhost:8000 )で学習活動を行う。

== Learning Locker
=== Adminユーザの作成
Learning LockerのAdminユーザを作成する。

----
EMAIL_ADDRESS=<e-mail-address>
ORGANIZATION=<organization>
PASSWORD=<password>
docker exec learninglocker bash -c '\
  source ~/.bashrc;
  node ./cli/dist/server createSiteAdmin "${EMAIL_ADDRESS}" "${ORGANIZATION}" "${PASSWORD}"'
----

=== ログイン
Learning Locker( http://localhost:3000/ )にAdminユーザのアカウントでログインし、組織を選択する。

[cols="a,a", frame=none, grid=none]
|===
| image::learninglocker/login.png[]
| image::learninglocker/select-org.png[]
|===

<<<
=== LRSの作成
サイドメニューの `[Settings] > [Stores]` から任意の名称でLRSを作成する。

image::learninglocker/stores.png[align=center]
image::learninglocker/add-new-lrs.png[align=center]

<<<
[[learninglocker_client_settings]]
=== クライアント情報の設定
サイドメニューの `[Settings] > [Clients]` から `New xAPI store client` を選択する。 +
`Overall Scopes` の `API All` にチェックを入れ、 `LRS (optional)` に上記で作成したLRSを指定する。

image::learninglocker/new-xapi-store-client.png[align=center]

<<<
== xAPIステートメント変換
=== 初期設定
スクリプトの設定ファイルを編集する。

.xapi/src/config/app.js
[source, javascript]
----
const config = {
…
  LRS: {
    ...
    client: {
      key: '<xapi-store-client-key>', // <1>
      secret: '<xapi-store-client-secret>' // <1>
    },
…
----
<1> <<learninglocker_client_settings>>で確認したLRSのクライアント情報を設定

設定ファイルの変更を `moodle-xapi` コンテナに反映する。

----
docker compose build moodle-xapi
docker compose up -d moodle-xapi
----

<<<
=== ステートメント変換
学習ログをxAPIステートメントに変換する。

----
docker exec moodle-xapi npm start
----

Learning Lockerにステートメントが登録されていることを確認する。

image::learninglocker/source.png[align=center]

[TIP]
====
変換が完了したログの件数を取得する場合は以下のコマンドを実行する。

----
docker exec learning-analytics-db \
  psql -U learning_analytics learning_analytics \
  -c "SELECT count(*) FROM xapi_records_processed;"
----

ログを再変換したい場合は、以下のコマンドで変換処理の実行履歴を削除する。

----
docker exec learning-analytics-db \
  psql -U learning_analytics learning_analytics \
  -c "DELETE FROM xapi_records_processed;"
----
====

<<<
== Caliperステートメント変換

[[caliper_settings]]
=== 初期設定
OpenLRWから取得したAPIキー( `mongoOrg.apiKey` )を `lrw.php` に設定する。

----
OPENLRW_DATABASE=caliper // <1>
OPENLRW_USERNAME=caliper // <1>
OPENLRW_PASSWORD=caliper // <1>
API_KEY=$(
  docker exec openlrw-mongo \
  mongo --quiet ${OPENLRW_DATABASE} \
    -u ${OPENLRW_USERNAME} \
    -p ${OPENLRW_PASSWORD} \
    --eval 'db.mongoOrg.findOne({"org.name": "DEFAULT_ORG"}, {_id:0,apiKey:1}).apiKey'
)

cat <<EOF > ./caliper/config/lrw.php
<?php

return [
    "tenants" => [
        "default" => "${API_KEY}"
    ]
];
EOF

docker compose build moodle-caliper
----
<1> link:../openlrw/.env[OpenLRWの設定] を参照

<<<
=== ステートメント変換
学習ログをCaliperステートメントに変換する。

----
docker compose run --rm moodle-caliper
----

OpenLRWにステートメントが登録されていることを確認する。

----
docker exec openlrw-mongo \
  mongo --quiet ${OPENLRW_DATABASE} \
    -u ${OPENLRW_USERNAME} \
    -p ${OPENLRW_PASSWORD} \
    --eval 'db.mongoEvent.find().pretty()'
----

<<<
== Superset
TIP: 操作方法の詳細は https://superset.apache.org/docs/creating-charts-dashboards/creating-your-first-dashboard[ユーザガイド - Creating Charts and Dashboards] を参照すること。

=== 初期設定
以下のコマンドを実行し、Adminユーザの作成やデータベースの初期設定を行う。

NOTE: Adminユーザのユーザ情報は `superset` の環境変数 `ADMIN_USERNAME` 、 `ADMIN_PASSWORD` 等で設定する。

----
docker exec superset /init.sh
----

=== ログイン
Superset( http://localhost:8088 )にAdminユーザでログインする（デフォルトのユーザ名・パスワードは `admin` ）。

image::superset/signin.png[align=center]

image::superset/home.png[align=center]

<<<
=== xAPIステートメントの可視化
`[Data] > [Datasets]` から `xapi_statements` を選択する。

image::superset/datasets.png[align=center]

<<<
「DATA」および「CUSTOMIZE」タブからチャートの設定を行い、「CREATE CHART」でステートメントを可視化する。

.ユーザの行動（ログイン、閲覧等）毎の件数を円グラフで可視化する例
[cols="30%,30%,40%"]
|===
   |大項目                   |小項目             |設定値
 2+|Visualization Type                           |`Pie Chart`
   |Time                     |TIME COLUMN        |`timestamp`
.2+|Query                    |DIMENSIONS         |`statement.verb.display.en`
                             |METRIC             |`COUNT(*)`
|===

image::superset/xapi-statements.png[align=center]

<<<
=== Caliperステートメントの可視化
`[Data] > [Datasets]` から `caliper_statements` を選択する。

image::superset/datasets.png[align=center]

<<<
「DATA」および「CUSTOMIZE」タブからチャートの設定を行い、「CREATE CHART」でステートメントを可視化する。

.ユーザの行動（ログイン、閲覧等）毎の件数を円グラフで可視化する例
[cols="30%,30%,40%"]
|===
   |大項目                   |小項目             |設定値
 2+|Visualization Type                           |`Pie Chart`
   |Time                     |TIME COLUMN        |`event.eventTime`
.2+|Query                    |DIMENSIONS         |`event.action`
                             |METRIC             |`COUNT(*)`
|===

image::superset/caliper-statements.png[align=center]

<<<
== JupyterHub
=== ログイン
JupyterHub( http://localhost:8001 )に `jupyter` ユーザ（パスワード: `jupyter` ）でログインする。

image::jupyterhub/signin.png[align=center, scaledwidth=50%]

ノートブック一覧の表示を確認する。

image::jupyterhub/notebooks.png[align=center]

<<<
[TIP]
====
ユーザを追加する場合は以下のコマンドを実行する。

----
USERNAME=<username>
PASSWORD=<password>
docker exec jupyterhub useradd -m -p $(echo "$PASSWORD" | openssl passwd -1 -stdin) -s /bin/bash $USERNAME
----
====

[WARNING]
====
Linux環境において、マウントしたホームディレクトリ（ `/home/jupyter` ）の所有者が適切に設定されず、権限エラーが発生する場合がある。

----
PermissionError: [Errno 13] Permission denied: '/home/jupyter/.local'
----

本問題が生じた場合には、実行ユーザのUID/GIDを以下の環境変数で指定し、コンテナを再起動すること。

.base.yaml
[source, diff]
----
  jupyterhub:
    ...
    environment:
      - LOCAL_UID=<uid> # id -u
      - LOCAL_GID=<gid> # id -g
----
====

<<<
=== xAPIステートメントの取得
link:../jupyterhub/notebooks/xAPI_statements.ipynb[xAPI_statements.ipynb]を使用して、xAPIステートメントを取得する例を示す。

image::jupyterhub/xapi-statements.png[align=center]

<<<
=== Caliperステートメントの取得
link:../jupyterhub/notebooks/Caliper_statements.ipynb[Caliper_statements.ipynb]を使用して、Caliperステートメントを取得する例を示す。

image::jupyterhub/caliper-statements.png[align=center]

== JupyterHub-Superset連携
=== ノートブック実行結果の登録
link:../jupyterhub/notebooks/Import_to_Superset.ipynb[Import_to_Superset.ipynb]に示す例に従って、ノートブックで加工したログをSupersetに登録する。

image::jupyterhub/import-to-superset.png[align=center]

<<<
=== ノートブック実行結果の可視化
Supersetの `[Data] > [Datasets]` から登録したデータセットにアクセスする。

image::superset/jupyter/datasets.png[align=center]

カラム等の設定を変更する場合には `[Actions] > [Edit]` からデータセットを編集する。 +
既存のデータセットを異なる構成で再登録した場合には、 `[Actions] > [Edit] > [COLUMNS]` から `SYNC COLUMNS FROM SOURCE` を押下し、変更を反映する。

image::superset/jupyter/edit-notebook-results.png[align=center, scaledwidth=70%]

<<<
チャートの設定を行い、ノートブックの実行結果を可視化する。

.ノートブックの実行結果を可視化する例
[cols="30%,30%,40%"]
|===
   |大項目                   |小項目             |設定値
 2+|Visualization Type                           |`Pie Chart`
   |Time                     |TIME COLUMN        |`timestamp`
.2+|Query                    |DIMENSIONS         |`object.definition.description.en`
                             |METRIC             |`COUNT(*)`
|===

image::superset/jupyter/visualize-notebook-results.png[align=center, scaledwidth=90%]
